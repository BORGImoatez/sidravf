<div class="rapports-container">
    <!-- LOADER GLOBAL -->
    <div *ngIf="isLoading" class="loader-overlay">
        <div class="loader-spinner"></div>
        <p class="loader-text">Chargement des donnÃ©es...</p>
    </div>

    <!-- HEADER -->
    <header class="page-header">
        <div class="page-header-left">
            <h1 class="page-title">Tableau de Bord National</h1>
            <p class="page-subtitle">Drogues, addictions & demandes de traitement</p>
            <p class="page-description">
                Visualisation des indicateurs clÃ©s avec filtres dynamiques.
            </p>
        </div>

        <div class="page-header-right">
            <div class="chip" *ngIf="filters.anneeConsultation === 0">
                ğŸ“… Toutes les annÃ©es
            </div>
            <div class="chip" *ngIf="filters.anneeConsultation !== 0">
                ğŸ“… AnnÃ©e {{ filters.anneeConsultation }}
            </div>
            <div class="chip">
                ğŸ‘¤ Sexe : {{ getSexeFilterLabel() }}
            </div>
            <div class="chip">
                ğŸ¯ Ã‚ge : {{ filters.ageMin }} - {{ filters.ageMax }} ans
            </div>
        </div>
    </header>
    <!-- BADGE MODE DEV -->
    <div class="dev-badge">
        <span class="dev-badge-icon">ğŸš§</span>
        <div class="dev-badge-content">
            <strong>Mode Test</strong>
            <span class="dev-badge-text">Version beta - ce n'est pas une version finale</span>
        </div>
    </div>
    <!-- MESSAGE D'ERREUR -->
    <div *ngIf="errorMessage" class="error-alert">
        <span class="error-icon">âš ï¸ </span>
        <div class="error-content">
            <strong>Erreur :</strong> {{ errorMessage }}
        </div>
        <button (click)="dismissError()" class="error-close">Ã—</button>
    </div>

    <!-- FILTRES -->
    <section class="filters-section card">
        <div class="card-header">
            <div class="card-header-left">
                <h3 class="card-title">ğŸ” Filtres</h3>
                <p class="card-subtitle">
                    Affinez lâ€™analyse selon le sexe, lâ€™annÃ©e de consultation et la tranche dâ€™Ã¢ge.
                </p>
            </div>
            <div class="card-header-right">
            <span class="pill pill-soft">
              {{ getActiveFiltersCount() }} filtre(s) actif(s)
            </span>
            </div>
        </div>
        <div class="card-body">
            <div class="filters-grid">
                <div class="filter-item">
                    <label class="filter-label">Sexe</label>
                    <select
                            [(ngModel)]="filters.sexe"
                            (change)="applyFilters()"
                            class="filter-select"
                            [disabled]="isLoading"
                    >
                        <option value="tous">Tous</option>
                        <option value="homme">Homme</option>
                        <option value="femme">Femme</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">AnnÃ©e de consultation</label>
                    <select
                            [(ngModel)]="filters.anneeConsultation"
                            (change)="applyFilters()"
                            class="filter-select"
                            [disabled]="isLoading"
                    >
                        <option [value]="0">Toutes les annÃ©es</option>
                        <option *ngFor="let annee of anneesDisponibles" [value]="annee">
                            {{ annee }}
                        </option>
                    </select>
                </div>

                <div class="filter-item filter-item-wide">
                    <label class="filter-label">
                        Tranche d'Ã¢ge : {{ filters.ageMin }} - {{ filters.ageMax }} ans
                    </label>
                    <div class="range-slider-container">
                        <input
                                type="range"
                                [(ngModel)]="filters.ageMin"
                                (input)="onAgeMinChange()"
                                class="range-slider"
                                min="10"
                                max="100"
                                step="1"
                                [disabled]="isLoading"
                        />
                        <input
                                type="range"
                                [(ngModel)]="filters.ageMax"
                                (input)="onAgeMaxChange()"
                                class="range-slider"
                                min="10"
                                max="100"
                                step="1"
                                [disabled]="isLoading"
                        />
                        <div class="range-values">
                            <span class="range-value">{{ filters.ageMin }} ans</span>
                            <span class="range-value">{{ filters.ageMax }} ans</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button
                        (click)="resetFilters()"
                        class="btn-secondary"
                        [disabled]="isLoading"
                >
                    ğŸ”„ RÃ©initialiser les filtres
                </button>
                <button
                        (click)="exportData()"
                        class="btn-primary"
                        [disabled]="isLoading || isExporting"
                >
                    <span *ngIf="!isExporting">ğŸ“¥ Exporter les donnÃ©es</span>
                    <span *ngIf="isExporting">â³ Export en cours...</span>
                </button>
            </div>
        </div>
    </section>

    <!-- INDICATEURS CLÃ‰S -->
    <section class="indicators-section" *ngIf="!isLoading">
        <h2 class="section-title">ğŸ“Š Indicateurs clÃ©s</h2>

        <div class="indicators-grid">
            <!-- Total consultations -->
            <div class="indicator-card card-primary">
                <div class="indicator-icon">ğŸ‘¥</div>
                <div class="indicator-content">
                    <div class="indicator-label">Total des consultations</div>
                    <div class="indicator-value">
                        {{ stats.totalConsultations | number }}
                    </div>
                    <p class="indicator-subtext" *ngIf="stats.totalConsultations > 0">
                        {{ getConsultationsParJour() | number : '1.0-1' }} / jour (approx.)
                    </p>
                </div>
            </div>

            <!-- Moyenne d'Ã¢ge -->
            <div class="indicator-card card-info">
                <div class="indicator-icon">ğŸ“…</div>
                <div class="indicator-content">
                    <div class="indicator-label">Moyenne d'Ã¢ge</div>
                    <div class="indicator-value">
                        {{ stats.moyenneAge | number : '1.1-1' }} ans
                    </div>
                    <p class="indicator-subtext">
                        Principalement : {{ getTrancheAgeDominante() || 'â€”' }}
                    </p>
                </div>
            </div>

            <!-- DÃ©cÃ¨s liÃ©s -->
            <div class="indicator-card card-danger">
                <div class="indicator-icon">âš ï¸</div>
                <div class="indicator-content">
                    <div class="indicator-label">DÃ©cÃ¨s liÃ©s aux drogues</div>
                    <div class="indicator-value">
                        {{ stats.decesLieDrogues | number }}
                    </div>
                    <p class="indicator-subtext" *ngIf="stats.totalConsultations > 0">
                        ~ {{ getTauxDeces() | number : '1.2-2' }} % des consultations
                    </p>
                </div>
            </div>

            <!-- Total demandes de traitement -->
            <div class="indicator-card card-success">
                <div class="indicator-icon">ğŸ¥</div>
                <div class="indicator-content">
                    <div class="indicator-label">Demandes de traitement</div>
                    <div class="indicator-value">
                        {{ stats.demandesTraitement.total | number }}
                    </div>
                    <p class="indicator-subtext">
                        Substance la plus frÃ©quente :
                        <strong>{{ getSubstanceTop() || 'â€”' }}</strong>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- LIGNE 1 : SEXE + Ã‚GE -->
    <section class="chart-row" *ngIf="!isLoading">
        <!-- Sexe -->
        <div class="card chart-card">
            <div class="card-header">
                <h3 class="card-title">ğŸ‘« RÃ©partition par sexe</h3>
                <p class="card-subtitle">
                    Proportion d'hommes et de femmes parmi les patients.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="sexeChartData"
                            [options]="sexeChartOptions"
                            [type]="sexeChartType"
                    >
                    </canvas>
                </div>
                <div class="chart-legend-inline">
                    <div class="legend-item">
                        <span class="legend-dot legend-dot-homme"></span>
                        <span>Hommes</span>
                        <span class="legend-value">
                  {{ stats.repartitionSexe.hommes | number }}
                            ({{ getSexePercentage('hommes') | number : '1.0-0' }} %)
                </span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot legend-dot-femme"></span>
                        <span>Femmes</span>
                        <span class="legend-value">
                  {{ stats.repartitionSexe.femmes | number }}
                            ({{ getSexePercentage('femmes') | number : '1.0-0' }} %)
                </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ã‚ge -->
        <div class="card chart-card">
            <div class="card-header">
                <h3 class="card-title">ğŸ¯ Demandes de traitement par tranche d'Ã¢ge</h3>
                <p class="card-subtitle">
                    Identification des tranches d'Ã¢ge les plus touchÃ©es.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="ageChartData"
                            [options]="ageChartOptions"
                            [type]="ageChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- LIGNE 2 : MODES + RÃ‰GIONS -->
    <section class="chart-row" *ngIf="!isLoading">
        <!-- Modes d'administration -->
        <div class="card chart-card" *ngIf="stats.modesAdministration.length > 0">
            <div class="card-header">
                <h3 class="card-title">ğŸ’Š Modes d'administration</h3>
                <p class="card-subtitle">
                    RÃ©partition des modes de consommation dÃ©clarÃ©s.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="modeAdminChartData"
                            [options]="modeAdminChartOptions"
                            [type]="modeAdminChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>

        <!-- Par rÃ©gion -->
        <div class="card chart-card" *ngIf="stats.demandesTraitement.parRegion.length > 0">
            <div class="card-header">
                <h3 class="card-title">ğŸ“ Demandes de traitement par rÃ©gion</h3>
                <p class="card-subtitle">
                    Comparaison des rÃ©gions selon le volume de demandes.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="regionChartData"
                            [options]="regionChartOptions"
                            [type]="regionChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- LIGNE 3 : SUBSTANCES -->
    <section class="chart-row" *ngIf="!isLoading && stats.demandesTraitement.parSubstance.length > 0">
        <div class="card chart-card full-width">
            <div class="card-header">
                <h3 class="card-title">ğŸ§ª Demandes de traitement par type de substance</h3>
                <p class="card-subtitle">
                    Vue dâ€™ensemble des substances les plus problÃ©matiques.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="substanceChartData"
                            [options]="substanceChartOptions"
                            [type]="substanceChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>
    </section>
    <!-- LIGNE 4 : PROFESSION + SITUATION FAMILIALE -->
    <section class="chart-row" *ngIf="!isLoading">
        <!-- Par profession -->
        <div class="card chart-card" *ngIf="stats.demandesTraitement.parProfession.length > 0">
            <div class="card-header">
                <h3 class="card-title">ğŸ’¼ Demandes de traitement par profession</h3>
                <p class="card-subtitle">
                    RÃ©partition des demandes selon la profession des patients.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="professionChartData"
                            [options]="professionChartOptions"
                            [type]="professionChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>

        <!-- Par situation familiale -->
        <div class="card chart-card" *ngIf="stats.demandesTraitement.parSituationFamiliale.length > 0">
            <div class="card-header">
                <h3 class="card-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Demandes par situation familiale</h3>
                <p class="card-subtitle">
                    Distribution selon le statut familial des patients.
                </p>
            </div>
            <div class="card-body chart-body">
                <div class="chart-wrapper">
                    <canvas
                            baseChart
                            [data]="situationFamilialeChartData"
                            [options]="situationFamilialeChartOptions"
                            [type]="situationFamilialeChartType"
                    >
                    </canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- LISTES DÃ‰TAILLÃ‰ES (COMPLÃ‰MENT) -->
    <section class="demandes-section" *ngIf="!isLoading">
        <h2 class="section-title">ğŸ“‹ DÃ©tails complÃ©mentaires</h2>

        <div class="demandes-grid">
            <!-- Par sexe -->
            <div class="card" *ngIf="stats.demandesTraitement.parSexe.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par sexe</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parSexe"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.sexe }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par NSE -->
            <div class="card" *ngIf="stats.demandesTraitement.parNSE.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par niveau socio-Ã©conomique</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parNSE"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.niveau }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par Ã¢ge (liste brute en complÃ©ment du chart) -->
            <div class="card" *ngIf="stats.demandesTraitement.parAge.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par tranche d'Ã¢ge (dÃ©tail)</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parAge"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.tranche }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- LISTES DÃ‰TAILLÃ‰ES (COMPLÃ‰MENT) -->
    <section class="demandes-section" *ngIf="!isLoading">
        <h2 class="section-title">ğŸ“‹ DÃ©tails des demandes de traitement</h2>

        <div class="demandes-grid">
            <!-- Par sexe -->
            <div class="card" *ngIf="stats.demandesTraitement.parSexe.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par sexe</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parSexe"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.sexe }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par profession -->
            <div class="card" *ngIf="stats.demandesTraitement.parProfession.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par profession</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parProfession"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.profession }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par NSE -->
            <div class="card" *ngIf="stats.demandesTraitement.parNSE.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par niveau socio-Ã©conomique</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parNSE"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.niveau }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par situation familiale -->
            <div
                    class="card"
                    *ngIf="stats.demandesTraitement.parSituationFamiliale.length > 0"
            >
                <div class="card-header">
                    <h4 class="card-title">Par situation familiale</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parSituationFamiliale"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.situation }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Par Ã¢ge (liste brute en complÃ©ment du chart) -->
            <div class="card" *ngIf="stats.demandesTraitement.parAge.length > 0">
                <div class="card-header">
                    <h4 class="card-title">Par tranche d'Ã¢ge (liste)</h4>
                </div>
                <div class="card-body">
                    <div class="demandes-list">
                        <div
                                *ngFor="let item of stats.demandesTraitement.parAge"
                                class="demande-row"
                        >
                            <span class="demande-label">{{ item.tranche }}</span>
                            <span class="demande-value">{{ item.nombre | number }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
